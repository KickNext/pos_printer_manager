#!/bin/sh
# =============================================================================
# Pre-commit —Ö—É–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Dart-—Ñ–∞–π–ª–æ–≤
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º
# –ù–∞ Windows –≤—ã–∑—ã–≤–∞–µ—Ç PowerShell —Å–∫—Ä–∏–ø—Ç
# =============================================================================

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ö—É–∫–æ–≤
HOOK_DIR="$(dirname "$0")"

# –ï—Å–ª–∏ PowerShell –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –µ—Å—Ç—å .ps1 —Ñ–∞–π–ª - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if command -v pwsh >/dev/null 2>&1 && [ -f "$HOOK_DIR/pre-commit.ps1" ]; then
    pwsh -ExecutionPolicy Bypass -File "$HOOK_DIR/pre-commit.ps1"
    exit $?
fi

# –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º bash-–≤–µ—Ä—Å–∏—é
echo "üîç –ó–∞–ø—É—Å–∫ pre-commit –ø—Ä–æ–≤–µ—Ä–æ–∫..."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö .dart —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.dart$" || true)

# –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö .dart —Ñ–∞–π–ª–æ–≤ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
if [ -z "$STAGED_DART_FILES" ]; then
    echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö Dart-—Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
    exit 0
fi

echo "üìù –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ Dart-—Ñ–∞–π–ª—ã:"
echo "$STAGED_DART_FILES"

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
echo ""
echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Dart-—Ñ–∞–π–ª–æ–≤..."

FORMAT_FAILED=0
for FILE in $STAGED_DART_FILES; do
    if [ -f "$FILE" ]; then
        dart format "$FILE"
        if [ $? -ne 0 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: $FILE"
            FORMAT_FAILED=1
        else
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏–Ω–¥–µ–∫—Å
            git add "$FILE"
        fi
    fi
done

if [ $FORMAT_FAILED -ne 0 ]; then
    echo ""
    echo "‚ùå –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
    exit 1
fi

echo ""
echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
exit 0
